<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supra Automation Assist</title>
    <link rel="stylesheet" href="assist/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="assist/assets/logo.png" type="image/png">
    <script src="https://unpkg.com/buffer@6.0.3/index.js"></script>
    <script src="https://unpkg.com/supra-l1-sdk@latest/dist/index.umd.js"></script>
    <script>
        (function() {
            let BufferPolyfill = null;
            if (typeof buffer !== 'undefined' && buffer.Buffer) {
                BufferPolyfill = buffer.Buffer;
            } else if (typeof Buffer !== 'undefined') {
                BufferPolyfill = Buffer;
            }
            
            if (BufferPolyfill) {
                window.Buffer = BufferPolyfill;
                console.log('Buffer polyfill setup complete. Methods available:', {
                    from: typeof BufferPolyfill.from,
                    alloc: typeof BufferPolyfill.alloc,
                    isBuffer: typeof BufferPolyfill.isBuffer
                });
            } else {
                console.error('Buffer polyfill failed to load');
                window.Buffer = {
                    from: function(data, encoding) {
                        if (data instanceof Uint8Array) {
                            return data;
                        }
                        const arr = new Uint8Array(data);
                        arr.toString = function(enc) {
                            if (enc === 'hex') {
                                return Array.from(this, byte => byte.toString(16).padStart(2, '0')).join('');
                            }
                            return Array.from(this).toString();
                        };
                        return arr;
                    }
                };
                console.log('Created minimal Buffer fallback');
            }
        })();
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Checking SDK availability...');
            console.log('SupraSDK object:', typeof SupraSDK);
            if (typeof SupraSDK !== 'undefined') {
                window.SupraClient = SupraSDK.SupraClient;
                window.HexString = SupraSDK.HexString;
                window.BCS = SupraSDK.BCS;
                console.log('SDK loaded via UMD build');
            } else {
                loadSDKFallback();
            }
        });        
        async function loadSDKFallback() {
            try {
                const module = await import('https://esm.sh/supra-l1-sdk@latest');
                window.SupraClient = module.SupraClient;
                window.HexString = module.HexString;
                window.BCS = module.BCS;
                console.log('SDK loaded via ES modules fallback');
            } catch (error) {
                console.error('All SDK loading methods failed:', error);
                window.supraSDKError = true;
            }
        }
    </script>
</head>
<body>

    <div class="particle-system"></div>
    <div class="floating-letters"></div>
    <div class="grid-overlay"></div>
    
    <!-- App Layout with Sidebar -->
    <div class="app-layout">
        
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-sidebar">
                    <span class="logo-text">AutoFi Assist</span>
                </div>
                <button class="btn-icon-only" id="toggleSidebar">
                    <span>‚ò∞</span>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#dashboard" class="nav-item active" data-section="dashboard">
                    <span class="nav-icon">‚òØ</span>
                    <span class="nav-label">Get Started</span>
                </a>
                <a href="#automation" class="nav-item" data-section="automation">
                    <span class="nav-icon">üñ±</span>
                    <span class="nav-label">Create Task</span>
                </a>
                <a href="#marketplace" class="nav-item" data-section="marketplace">
                    <span class="nav-icon">‚ò∞</span>
                    <span class="nav-label">Marketplace</span>
                </a>
                <a href="#tasks" class="nav-item" data-section="tasks">
                    <span class="nav-icon">ñ£ê</span>
                    <span class="nav-label">My Tasks</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <a href="https://docs.supra.com/automation" target="_blank" class="footer-link">
                    <span class="footer-icon">üìö</span>
                    <span>Documentation</span>
                </a>
                <a href="https://discord.gg/supralabs" target="_blank" class="footer-link">
                    <span class="footer-icon">üí¨</span>
                    <span>Support</span>
                </a>
            </div>
        </aside>
        
        <!-- Main Content Area -->
        <main class="main-content">
            
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="page-title">
                    <h1 id="pageTitle">Get Started with Supra AutoFi</h1>
                    <p id="pageSubtitle">Professional automation tooling for Supra developers</p>
                </div>
                <div class="top-bar-actions">
                    <div class="network-badge">
                        <span class="network-dot"></span>
                        <span id="topBarNetwork">Testnet</span>
                    </div>
                    <button class="disconnect-wallet-btn" id="disconnectWallet" style="display: none;">
                        <span class="disconnect-icon">üîå</span>
                        <span>Disconnect Wallet</span>
                    </button>
                </div>
            </div>
            
            <!-- Dashboard Section -->
            <section id="dashboardSection" class="content-section active">
                
                <!-- Network Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon network-icon">üåê</div>
                            <div class="stat-label">Network Status</div>
                        </div>
                        <div class="stat-value" id="networkStatus">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon countdown-icon">‚è±Ô∏è</div>
                            <div class="stat-label">Next Epoch In</div>
                        </div>
                        <div class="stat-value countdown-value" id="timeToNext">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon fee-icon">üí∞</div>
                            <div class="stat-label">Automation Fee</div>
                        </div>
                        <div class="stat-value" id="estimatedFee">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Ready-to-Use Values -->
                <div class="values-panel">
                    <h3 class="panel-title">
                        Ready-to-Use Values
                    </h3>
                    
                    <div class="values-grid">
                        <div class="value-card">
                            <div class="value-header">
                                <span class="value-label">--task-expiry-time-secs</span>
                                <button class="copy-btn" onclick="copyToClipboard('expiryTimeValue', this)">
                                    <span class="copy-icon">üìã</span>
                                    Copy
                                </button>
                            </div>
                            <div class="value-content" id="expiryTimeValue">Calculating...</div>
                        </div>
                        
                        <div class="value-card">
                            <div class="value-header">
                                <span class="value-label">--task-automation-fee-cap</span>
                                <button class="copy-btn" onclick="copyToClipboard('feeCapValue', this)">
                                    <span class="copy-icon">üìã</span>
                                    Copy
                                </button>
                            </div>
                            <div class="value-content" id="feeCapValue">Calculating...</div>
                        </div>
                        
                        <div class="value-card full-width">
                            <div class="value-header">
                                <span class="value-label">Complete CLI Command</span>
                                <button class="copy-btn" onclick="copyToClipboard('cliTemplate', this)">
                                    <span class="copy-icon">üìã</span>
                                    Copy
                                </button>
                            </div>
                            <div class="value-content cli-content" id="cliTemplate">Generating...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="action-btn primary" onclick="navigateToSection('automation')">
                        <span>Create Automation Task</span>
                    </button>
                    <button class="action-btn secondary" onclick="navigateToSection('marketplace')">
                        <span>Browse Marketplace</span>
                    </button>
                    <button class="action-btn secondary" onclick="navigateToSection('tasks')">
                        <span>View My Tasks</span>
                    </button>
                </div>
            </section>
            
            <!-- Automation Section -->
            <section id="automationSection" class="content-section">
                
                <div class="section-header">
                    <h2 class="section-title">Create Automation Task</h2>
                    <p class="section-subtitle">Connect wallet ‚Üí Select module ‚Üí Configure ‚Üí Deploy</p>
                </div>
                
                <!-- Visual Flow Builder -->
                <div class="flow-builder">
                    <div class="flow-stage" id="flowStage1" data-step="1">
                        <div class="flow-node trigger-node">
                            <div class="node-icon">üîå</div>
                            <div class="node-title">Connect</div>
                            <div class="node-status" id="nodeStatus1">Start here</div>
                        </div>
                    </div>
                    
                    <div class="flow-connector"></div>
                    
                    <div class="flow-stage" id="flowStage2" data-step="2">
                        <div class="flow-node select-node">
                            <div class="node-icon">üì¶</div>
                            <div class="node-title">Module</div>
                            <div class="node-status" id="nodeStatus2">Pending</div>
                        </div>
                    </div>
                    
                    <div class="flow-connector"></div>
                    
                    <div class="flow-stage" id="flowStage3" data-step="3">
                        <div class="flow-node function-node">
                            <div class="node-icon">‚öôÔ∏è</div>
                            <div class="node-title">Function</div>
                            <div class="node-status" id="nodeStatus3">Pending</div>
                        </div>
                    </div>
                    
                    <div class="flow-connector"></div>
                    
                    <div class="flow-stage" id="flowStage4" data-step="4">
                        <div class="flow-node deploy-node">
                            <div class="node-icon">üöÄ</div>
                            <div class="node-title">Configure & Deploy</div>
                            <div class="node-status" id="nodeStatus4">Pending</div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 1: Connect Wallet -->
                <div class="wizard-step active" id="step-1">
                    <div class="step-card">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <div class="step-info">
                                <h3 class="step-title">Connect Wallet or Enter Address</h3>
                                <p class="step-desc">Connect your Starkey wallet or manually enter an account address</p>
                            </div>
                        </div>
                        <div class="step-content">
                            <div class="connect-options">
                                <button class="connect-btn" id="connectWallet">
                                    <span class="btn-text">Connect Starkey Wallet</span>
                                </button>
                                <span class="or-divider">OR</span>
                                <div class="manual-input-group">
                                    <input type="text" 
                                           id="manualAddress" 
                                           class="wizard-input" 
                                           placeholder="Enter account address (0x...)"
                                           maxlength="66">
                                    <button class="use-btn" id="useManualAddress">
                                        <span class="btn-icon">üîç</span>
                                        <span class="btn-text">Use Address</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="module-count-config">
                                <label for="moduleCount">
                                    <span class="label-text">Number of modules to fetch:</span>
                                    <span class="hint-icon" title="Specify how many modules to fetch from your account. Default is 50, but you can increase it to see more modules.">?</span>
                                </label>
                                <input type="number" 
                                       id="moduleCount" 
                                       class="wizard-input compact" 
                                       value="50"
                                       min="1"
                                       max="200">
                                <small class="input-hint">Recommended: 40-50 modules. Max: 200</small>
                            </div>
                            
                            <div class="wallet-status" id="walletStatus" style="display: none;">
                                <div class="status-badge success">
                                    <span class="status-icon">‚úÖ</span>
                                    <span>Connected: <strong id="walletAddress"></strong></span>
                                </div>
                            </div>
                            
                            <div class="loading-state" id="autoScanStatus" style="display: none;">
                                <div class="loading-spinner"></div>
                                <span>Scanning for modules...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Select Module -->
                <div class="wizard-step" id="step-2">
                    <div class="step-card">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <div class="step-info">
                                <h3 class="step-title">Select Module</h3>
                                <p class="step-desc">Choose a module to explore its entry functions</p>
                            </div>
                        </div>
                        <div class="step-content">
                            <div class="modules-grid" id="modulesList"></div>
                            <div class="loading-state" id="abiLoading" style="display: none;">
                                <div class="loading-spinner"></div>
                                <span>Loading module functions...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Select Function -->
                <div class="wizard-step" id="step-3">
                    <div class="step-card">
                        <div class="step-header">
                            <div class="step-number">3</div>
                            <div class="step-info">
                                <h3 class="step-title">Select Entry Function</h3>
                                <p class="step-desc">Pick the entry function to automate</p>
                            </div>
                        </div>
                        <div class="step-content">
                            <div class="functions-grid" id="functionsList"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 4: Configure & Deploy -->
                <div class="wizard-step" id="step-4">
                    <div class="step-card">
                        <div class="step-header">
                            <div class="step-number">4</div>
                            <div class="step-info">
                                <h3 class="step-title">Configure Parameters & Deploy</h3>
                                <p class="step-desc">Set function arguments, automation settings, then choose deployment method</p>
                            </div>
                        </div>
                        <div class="step-content">
                            <div class="params-layout">
                                <div class="params-section">
                                    <h4 class="params-title">Function Parameters</h4>
                                    <div id="functionParams" class="params-container"></div>
                                </div>
                                
                                <!-- Duration Slider Section -->
                                <div class="duration-slider-section">
                                    <div class="duration-slider-title">
                                        ‚è±Ô∏è Automation Duration
                                    </div>
                                    <div class="slider-container">
                                        <input type="range" id="durationSlider" class="duration-slider" 
                                               min="1" max="30" value="7" step="1">
                                        <div class="duration-display">
                                            <span class="duration-value" id="durationValue">7 days</span>
                                            <span class="duration-max">Max: 30 days</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Cost Estimates -->
                                    <div class="cost-estimates">
                                        <div class="cost-card">
                                            <div class="cost-info">
                                                <div class="cost-label">Estimated Total Cost</div>
                                                <div class="cost-value" id="estimatedCost">144.00 SUPRA</div>
                                            </div>
                                        </div>
                                        <div class="cost-card">
                                            <div class="cost-info">
                                                <div class="cost-label">Estimated Transactions</div>
                                                <div class="cost-value" id="estimatedTxs">~2,016 txs</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Advanced Settings (Collapsible) -->
                                <div class="advanced-settings">
                                    <button class="settings-toggle" id="settingsToggle" type="button">
                                        <span>‚öôÔ∏è Advanced Settings</span>
                                        <span class="settings-toggle-icon">‚ñº</span>
                                    </button>
                                    <div class="settings-content" id="settingsContent">
                                        <div class="params-section">
                                            <div class="automation-params">
                                                <div class="param-row">
                                                    <label>
                                                        Max Gas Amount
                                                        <span class="hint-icon" title="Maximum amount of gas that can be consumed by this automation task.">?</span>
                                                    </label>
                                                    <input type="number" id="maxGasAmount" value="5000" class="param-input" min="1000" max="1000000">
                                                </div>
                                                <div class="param-row">
                                                    <label>
                                                        Gas Price Cap
                                                        <span class="hint-icon" title="Maximum gas price you're willing to pay per unit of gas.">?</span>
                                                    </label>
                                                    <input type="number" id="gasPriceCap" value="200" class="param-input" min="1" max="10000">
                                                </div>
                                                <div class="param-row">
                                                    <label>
                                                        Expiry Time (seconds)
                                                        <span class="hint-icon" title="Unix timestamp when this automation task expires. Auto-calculated from duration slider.">?</span>
                                                    </label>
                                                    <input type="number" id="expiryTimeAuto" readonly class="param-input readonly">
                                                    <small>Auto-calculated from duration slider</small>
                                                </div>
                                                <div class="param-row">
                                                    <label>
                                                        Automation Fee Cap
                                                        <span class="hint-icon" title="Maximum fee you'll pay for the automation service. Auto-calculated based on your max gas amount.">?</span>
                                                    </label>
                                                    <input type="text" id="automationFeeAuto" readonly class="param-input readonly">
                                                    <small>Auto-calculated from network data</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Deployment Options -->
                            <div class="deployment-section">
                                <h4 class="deployment-title">
                                    <span class="deployment-icon">üöÄ</span>
                                    Choose Deployment Method
                                </h4>
                                
                                <div class="deployment-summary-compact">
                                    <div class="summary-badge">
                                        <strong>Module:</strong> <span id="summaryModule">-</span>
                                    </div>
                                    <div class="summary-badge">
                                        <strong>Function:</strong> <span id="summaryFunction">-</span>
                                    </div>
                                </div>
                                
                                <div class="deploy-methods">
                                    <div class="method-card">
                                        <div class="method-icon">>_</div>
                                        <h4>CLI Command</h4>
                                        <p>Generate a ready-to-use terminal command</p>
                                        <button class="deploy-btn secondary full-width" id="generateCommand">
                                            <span class="btn-icon">üìã</span>
                                            <span class="btn-text">Generate CLI Command</span>
                                        </button>
                                    </div>
                                    
                                    <div class="method-card">
                                        <div class="method-icon">‚¨Ü</div>
                                        <h4>Direct Signing</h4>
                                        <p>Sign and Register Directly with Starkey wallet</p>
                                        <button class="deploy-btn primary full-width" id="signTransaction">
                                            <span class="btn-icon">¬ª</span>
                                            <span class="btn-text">Register from Starkey</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="deploy-status" id="deployStatus" style="display: none;"></div>
                                <div class="transaction-status" id="transactionStatus" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </section>
            
            <!-- Marketplace Section -->
            <section id="marketplaceSection" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">AutoFi Marketplace</h2>
                    <p class="section-subtitle">Discover and use automation modules shared by the Supra community</p>
                </div>
                
                <div class="marketplace-header">
                    <div class="marketplace-stats">
                        <div class="stat-badge">
                            <span class="badge-icon">üì¶</span>
                            <span class="badge-text"><strong id="totalModules">0</strong> Modules</span>
                        </div>
                        <div class="stat-badge">
                            <span class="badge-icon">üë•</span>
                            <span class="badge-text"><strong id="totalContributors">0</strong> Contributors</span>
                        </div>
                    </div>
                    <div class="marketplace-filters">
                        <input type="text" 
                               id="marketplaceSearch" 
                               class="search-input" 
                               placeholder="üîç Search modules...">
                        <select id="categoryFilter" class="filter-select">
                            <option value="all">All Categories</option>
                            <option value="Payment">Payments</option>
                            <option value="NFT">NFT</option>
                            <option value="SocialFi">SocialFi</option>
                            <option value="Trading">Trading</option>
                        </select>
                    </div>
                </div>
                
                <div class="marketplace-grid" id="marketplaceGrid"></div>
                
                <div class="marketplace-cta">
                    <div class="cta-content">
                        <h4>Want to share your automation module?</h4>
                        <p>Contribute to the community by submitting your automation modules</p>
                    </div>
                    <a href="https://github.com/Supra-Labs/Supra-Automation-assist/" target="_blank" class="cta-btn">
                        <span class="btn-icon">üí°</span>
                        <span class="btn-text">Submit Your Module</span>
                    </a>
                </div>
            </section>
            
            <!-- Tasks Section -->
            <section id="tasksSection" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">My Completed Automation Tasks</h2>
                    <p class="section-subtitle">View your successfully executed automation tasks</p>
                </div>
                
                <div class="tasks-header">
                    <button class="refresh-btn" id="refreshTasks">
                        <span class="btn-icon">üîÑ</span>
                        <span class="btn-text">Refresh</span>
                    </button>
                </div>
                
                <div class="loading-state" id="tasksLoading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <span>Loading automated tasks...</span>
                </div>
                
                <div class="tasks-grid" id="automatedTasksList"></div>
                
                <div class="no-tasks-state" id="noTasksState" style="display: none;">
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <div class="empty-title">No Automated Tasks Found</div>
                        <div class="empty-desc">You haven't created any automated tasks yet. Use the wizard to create your first automation!</div>
                        <button class="action-btn primary" onclick="navigateToSection('automation')">
                            <span class="btn-icon">üöÄ</span>
                            <span>Create First Task</span>
                        </button>
                    </div>
                </div>
            </section>
            
        </main>
        
        <!-- Right Panel (Optional - Price Ticker) -->
        <!-- Uncomment to enable
        <aside class="price-ticker">
            <div class="ticker-header">
                <span class="ticker-icon">üìä</span>
                <h3>Live Prices</h3>
            </div>
            <div class="price-list" id="priceList"></div>
        </aside>
        -->
        
    </div>
    
    <div class="status-bar">
        <div class="status-dot"></div>
        <span>Updates every 5 seconds</span>
        <span>‚Ä¢</span>
        <span>Built for <strong>Supra</strong> AutoFi</span>
        <span>‚Ä¢</span>
        <a href="https://docs.supra.com" style="color: #DD1438; text-decoration: none;">Docs</a>
    </div>
    
    <script src="assist/js/autofimarketplace.js"></script>
    <script src="assist/js/helper.js"></script>
</body>
</html>